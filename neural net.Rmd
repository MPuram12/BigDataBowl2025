---
title: "Untitled"
author: "Will Kinnebrew"
date: "2025-10-27"
output:
  pdf_document: default
  html_document: default
---
```{r}
library(dplyr)
library(caret)
library(ggplot2)
library(viridis)
library(tidyverse)
library(h2o)

```

```{r}
df <- read.csv("full_clean_data.csv")
df <- df %>% 
  group_by(game_id, play_id) %>% 
  mutate(final_frame = ifelse(max(frame_id) == frame_id, 1, 0))
```



```{r}
df_filtered <- df %>%
  drop_na(dist_to_ball_land, speed, accel, direction, accel_direction, optimal_angle, angle_diff)

df_filtered <- df_filtered %>%
  group_by(game_id, play_id, nfl_id) %>%
  mutate(reached_ball = ifelse(dist_to_ball_land < 1.5, 1, 0)) %>% 
  mutate(reached_ball = ifelse(any(final_frame == 1 & reached_ball == 1), 1, 0)) %>%
  ungroup()
```

```{r}
h2o.init()


df_model <- df_filtered %>%
  mutate(
    nfl_id = as.factor(nfl_id),
    reached_ball = as.factor(reached_ball)
  ) %>%
  select(dist_to_ball_land, speed, accel, angle_diff, time_left_s, nfl_id, reached_ball)


set.seed(123)
train_idx <- sample(1:nrow(df_model), 0.8 * nrow(df_model))
train <- df_model[train_idx, ]
test  <- df_model[-train_idx, ]


train_h2o <- as.h2o(train)
test_h2o  <- as.h2o(test)


features <- c("dist_to_ball_land", "speed", "accel", "angle_diff", "time_left_s", "nfl_id")
target   <- "reached_ball"

model <- h2o.deeplearning(
  x = features,
  y = target,
  training_frame = train_h2o,
  hidden = c(64, 32),
  epochs = 30,
  activation = "Rectifier",
  categorical_encoding = "OneHotInternal",
  stopping_metric = "AUC",
  seed = 123
)

perf <- h2o.performance(model, newdata = test_h2o)
h2o.auc(perf)
h2o.confusionMatrix(perf)


pred <- h2o.predict(model, test_h2o)
pred_probs <- as.vector(pred$p1)
pred_class <- as.vector(pred$predict)


plot_df <- as.data.frame(test_h2o) %>%
  mutate(pred_prob = pred_probs)

ggplot(plot_df, aes(x = dist_to_ball_land, y = speed, color = pred_prob)) +
  geom_point(alpha = 0.7) +
  scale_color_viridis_c() +
  labs(
    title = "Predicted Probability of Reaching the Ball (h2o)",
    x = "Distance to Ball",
    y = "Speed",
    color = "Predicted Probability"
  ) +
  theme_minimal()

```

```{r}
model_no_id <- h2o.deeplearning(
  x = c("dist_to_ball_land", "speed", "accel", "angle_diff", "time_left_s"),
  y = target,
  training_frame = train_h2o,
  hidden = c(64, 32),
  epochs = 30,
  activation = "Rectifier",
  stopping_metric = "AUC",
  seed = 123
)

```

```{r}
perf2 <- h2o.performance(model_no_id, newdata = test_h2o)
h2o.auc(perf2)
h2o.confusionMatrix(perf2)


pred2 <- h2o.predict(model_no_id, test_h2o)
pred_probs2 <- as.vector(pred2$p1)
pred_class2 <- as.vector(pred2$predict)

plot_df <- plot_df %>% 
  mutate(prob2 = pred_probs2) %>% 
  mutate(effect = pred_prob - prob2)
  
```

```{r}
library(nflreadr)
players <- load_players()
```

```{r}
plot_df <- plot_df %>% 
  left_join(players %>% 
              select(nfl_id, display_name, pff_position), by = c("nfl_id"))
```

```{r}
plot_df %>% 
  group_by(nfl_id) %>%
  summarise(name = unique(display_name), 
            n = n(), 
            avg = round(mean(effect), 5), 
            total = round(sum(effect), 5), 
            pos = unique(pff_position)) %>% 
  filter(n > 50) %>% 
  arrange(desc(avg))
```
```{r}
varimp <- h2o.varimp(model)
varimp
```



```{r}
perf3 <- h2o.performance(model, newdata = as.h2o(df_filtered))
h2o.auc(perf3)
h2o.confusionMatrix(perf3)


pred3 <- h2o.predict(model, as.h2o(df_filtered))
pred_probs3 <- as.vector(pred3$p1)
pred_class3 <- as.vector(pred3$predict)
```

```{r}
perf4 <- h2o.performance(model_no_id, newdata = as.h2o(df_filtered))
h2o.auc(perf4)
h2o.confusionMatrix(perf4)


pred4 <- h2o.predict(model_no_id, as.h2o(df_filtered))
pred_probs4 <- as.vector(pred4$p1)
pred_class4 <- as.vector(pred4$predict)
```


```{r}
data <- df_filtered %>% 
  mutate(pred1 = pred_probs3, pred2 = pred_probs4, effect = pred1 - pred2) %>% 
  left_join(players %>% mutate(nfl_id = as.numeric(nfl_id)) %>% select(nfl_id, display_name, pff_position), by = c("nfl_id"))
```


```{r}
a <- data %>% 
  group_by(nfl_id) %>%
  summarise(name = unique(display_name), 
            n = n(), 
            avg = round(mean(effect), 5), 
            total = round(sum(effect), 5), 
            pos = unique(pff_position)) %>% 
  #filter(n > 50, pos != "WR", pos != "TE", pos != "HB") %>% 
  filter(n > 50, pos == "CB") %>% 
  arrange(desc(avg))
```

```{r}
plays <- data %>%
  group_by(game_id, play_id, nfl_id, display_name, pff_position) %>%
  summarise(
    start_prob1 = pred1[frame_id == min(frame_id)],   # probability at first frame
    end_prob1   = pred1[frame_id == max(frame_id)],   # probability at last frame
    start_prob2 = pred2[frame_id == min(frame_id)],   # probability at first frame
    end_prob2   = pred2[frame_id == max(frame_id)],   # probability at last frame
    n_frames   = n(),
    .groups = "drop"
  ) %>% 
  mutate(change1 = end_prob1 - start_prob1, change2 = end_prob2 - start_prob2)
```

```{r}
plays %>% 
  group_by(nfl_id) %>% 
  summarise(n = n(),
            avg1 = mean(change1), 
            avg2 = mean(change2), 
            total1 = sum(change1),
            total2 = sum(change2),
            effect_avg = avg1 - avg2,
            effect_tot = total1 - total2
            ) %>% 
  left_join(players %>% mutate(nfl_id = as.numeric(nfl_id)) %>% select(nfl_id, display_name, pff_position), by = c("nfl_id")) %>% 
  select(nfl_id, display_name, everything()) %>% 
  filter(n > 50) %>% 
  arrange(desc(effect_avg))
```


```{r}
test_df <- expand.grid(
  nfl_id = 53434, # 54508 for wandale robinson, 44881 for cooper kupp, 53434 jamarr chase
  dist_to_ball_land = seq(1, 40),
  time_left_s = 4,
  angle_diff = seq(0, 180, 10),
  speed = 20, 
  accel = 0
)

test_pred <- h2o.predict(model, as.h2o(test_df))
test_probs <- as.vector(test_pred$p1)

test_df <- test_df %>% 
  mutate(pred = test_probs)

# Mirror your 0–180° data to make a full 0–360° field
test_df_mirrored <- test_df %>%
  mutate(angle_diff_mirror = angle_diff) %>%
  bind_rows(
    test_df %>%
      mutate(angle_diff_mirror = 360 - angle_diff)
  ) %>% 
  mutate(reach = pred > .5)

# Plot: 0° straight up, increasing clockwise
ggplot(test_df_mirrored, aes(x = angle_diff_mirror, y = dist_to_ball_land, fill = pred)) +
  geom_tile() +
  coord_polar(start = 0, direction = 1) +  # ✅ This combination puts 0° at top and increases clockwise
  scale_fill_viridis_c(option = "plasma", name = "Reach Prob.") +
  scale_x_continuous(
    breaks = seq(0, 330, 30),
    labels = paste0(seq(0, 330, 30), "°")
  ) +
  scale_y_continuous(
    limits = c(0,30),
    breaks = seq(0, 40, 5),
    name = "Distance to Ball Landing"
  ) +
  labs(
    title = "Reachable Area Heat Map",
    subtitle = paste("Time Remaining:", test_df_mirrored$time_left_s, "Seconds"),
    x = "Angle (°)",
    y = "Distance"
  ) +
  theme_minimal(base_size = 13) +
  theme(
    panel.grid.minor = element_blank(),
    panel.grid.major = element_line(color = "gray80", linetype = "dotted"),
    plot.title = element_text(hjust = 0.5, face = "bold"),
    axis.text.x = element_text(size = 10, face = "bold"),
    legend.position = "right"
  ) +
  # Optional: show the player in the center
  annotate("point", x = 0, y = 0, size = 4, color = "white")


```

```{r}
extra_data <- data %>% 
  select(game_id, play_id, frame_id, x, y, 15:28)
```


```{r}
#tracking_df <- tracking_df %>% left_join(extra_data, by = c("game_id", "play_id", "frame_id", "x", "y")) %>% 
#  mutate(pred1 = round(pred1, 3),
#         pred2 = round(pred2, 3))
```